# 인증을 위한 준비
## 
```bash
# Simple Tip : make random json key
openssl rand -hex 32
```
## 인증 객체를 정의
```python
# 인증 관련 업무를 담당할 OAuth2PasswordBearer 객체를 정의,
# 액세스 토큰 발급 / 검증을 책임질 메서드를 만들어 노출한다.
from datetime import datetime, timedelta
from typing import Optional

from fastapi.security import OAuth2PasswordBearer
from jose import jwt
#Important. 이곳의 토큰 url이 이후 실제 엔드포인트의 url 과 일치해야한다.
oauth2_schema = OAuth2PasswordBearer(tokenUrl="token")

SECRET_KEY = "9c9d4a675e2c8bec57b782adcc802d0128a1a33db325b2f58c323b4f625bfb05"
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTE = 30


def create_access_token(data: dict, expires_delta: Optional[timedelta] = None):
    to_encode = data.copy()
    if expires_delta:
        expire = datetime.utcnow() + expires_delta
    else:
        expire = datetime.utcnow() + timedelta(minutes=15)
    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt
```
## 로그인 라우터
```python
# 로그인을 위한 별도 라우터 작성
router = APIRouter(
    tags=["authentication"],
)
# 로그인을 위한 오퍼레이션
router.post("/token")
def get_token(
    request: OAuth2PasswordRequestForm = Depends(), db: Session = Depends(get_db)
):
    # 인증을 위해 db로부터 유저 정보를 쿼리
    user = db.query(DbUser).filter(DbUser.username == request.username).first()
    if not user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="credit invalid",
        )
    # 외부의 해시 비교 모듈로 비밀번호를 비교
    if not Hash.verify(str(user.password), request.password):
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="invalid password",
        )
    access_token = oauth2.create_access_token(data={"sub": user.username})

    return {
        "access_token": access_token,
        "token_type": "bearer",
        "user_id": user.id,
        "user_name": user.username,
    }
    # TODO : 이후 main 에 라우터 추가할 것.
```
## 엔드포인트에 인증 추가
```python
# version 1
@router.get("/{id}", response_model=ArticleDisplay)
def get_article(
    id: int, db: Session = Depends(get_db),
    token: str = Depends(oauth2_schema), #인증 객체에 의존하면, 헤더로 전송된 토큰 자체를 얻어올 수 있다.
):
    return db_article.get_article(db, id)
# version 2
@router.get("/{id}")
def get_article(
    id: int, db: Session = Depends(get_db),
    user: UserBase = Depends(get_current_user), # 아예 인증객체로부터 회원 정보를 받아온다.
):
    return db_article.get_article(db, id)

```
```python
# db에서 회원 정보
def get_current_user(
    token: str = Depends(oauth2_schema),
    db: Session = Depends(get_db),
):
    credentials_exception = HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail="could not validate credentials",
        headers={"WWW-Authenticate": "Bearer"},
    )
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username = payload.get("sub")
        if username is None:
            raise credentials_exception
    except JWTError:
        raise credentials_exception
    user = db_user.get_user_by_username(db, username)
    return user
```