# FastApi 에 DB 조작 디펜던시를 통합하는 법
## Depends
- FastApi 에 외부 의존성을 결합하기 위한 방법
- Depends 객체를 활용
```python
from fastapi import Depends

# 복잡한 함수가 있다고 가정
def say_hello():
    return {"message" : "hi hello!"}

from fastapi import Body
@router.post('/new/{id}/comment')
def create_comment(
    id: int,
    comment_content: str = Body('hi, how are you'),
    req_param: dict = Depends(say_hello), # 이렇게 사용
    ):
    return {
        'id' : id,
        'raq': raq_param,
    }
```
- 그래서 이 Depends 를 어디다 쓰냐?
- Auth 에서 자주 쓴다. 

## DB Checklist
```markdown
# 이하의 요소를 전부 구현했는지 체크하자.
1. Database Definition : database.py
2. Model Definition : models.py
3. Create database : main.py
4. Schema Definition : schemas.py
5. ORM Functionality : db_user.py(repository)
6. API Functionality : user.py (router)
```

## DB Definition
```python
# DB 클라이언트를 인스턴스화
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
 
SQLALCHEMY_DATABASE_URL = "sqlite:///./fastapi-practice.db"
 
engine = create_engine(
    SQLALCHEMY_DATABASE_URL, connect_args={"check_same_thread": False}
)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
 
Base = declarative_base()
```
## Model Definition
```python
from sqlalchemy import Column
from sqlalchemy.sql.sqltypes import Integer, String


# 위에서 만든 DB 인스턴스 객체를 임포트, 상속한다.
from src.db.database import Base
class DBUser(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True, index=True)
    username = Column(String)
    email = Column(String)
    password = Column(String)
```
## Create Db instance At Main
```python
from fastapi import FastAPI

from src.db import models # 모델 객체 임포트
from src.db.database import engine # 인스턴스 객체의 엔진 사용
from src.routers import blog_get, blog_post

app = FastAPI()
app.include_router(blog_get.router)
app.include_router(blog_post.router)


@app.get("/")
def index():
    return "Hello World!"

models.Base.metadata.create_all(engine) # 해당 모델의 내용으로, db 인스턴스 초기화
```

## Schema Difinition (Dto)

```python
# 파이덴틱을 활용해, 웹서버단에서 다룰, request 를 그대로 담을 객체를 정의.
from pydantic import BaseModel

class UserBase(BaseModel):
    username: str
    email: str
    password: str
```

## ORM functionaliry (Repository)
- DB에 실제로 데이터를 삽입하는 Repository 단의 코드
- SqlAlchemy 를 ORM 으로 활용해서 DB와의 커플링을 줄이고, SQL을 직접 작성하지 않음.
```python
from sqlalchemy.orm.session import Session

from src.db.hash import Hash
from src.db.models import DbUser
from src.schemas import UserBase

def create_user(db: Session, request: UserBase):
    new_user = DbUser(
        username=request.username,
        email=request.email,
        password=Hash.bcrypt(request.password),
    )
    db.add(new_user)
    db.commit()  # 자동 생성 ID 가 이 시점에 DB에서 생겨난다.
    db.refresh(new_user)  # 자동생성된 ID를 받아오기 위한 리프래시
    return new_user
```
### 보안의 기본 : 비밀번호 해싱
- 필요 의존성 : passlib, bcrypt
```python
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
class Hash:
    @staticmethod
    def bcrypt(password: str):
        return pwd_context.hash(password)

    @staticmethod
    def verify(hashed_password: str, plain_password: str):
        return pwd_context.verify(plain_password, hashed_password)
```

## ORM functionaliry (Router)
```python
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from src.db import db_user
from src.db.database import get_db
from src.schemas import UserBase

# 일반적인 라우터 작성 코드
router = APIRouter(
    prefix="/user",
    tags=["user"],
)
@router.post("/", response_model=UserDisplay) #아래에서 정의할 DTO로 리스폰스
def create_user(request: UserBase, db: Session = Depends(get_db)): # 리퀘스트로부터 스키마를 받고, DB연결 세션은 Depends 를 활용해서 함수로 확보한다.
    return db_user.create_user(db, request) #db를 레포지토리에 넘겨주면서 쓰는게 일반적인 패턴.
```
### Responses용 Dto 만들기
```python
class UserDisplay(BaseModel):
    username: str
    email: str
    class Config: # 이 녀석이 중요!!! ORM의 DB용 객체를 데이터타입으로 변환해줌
        orm_mode = True

```

# 최종 정리
- Sqlite Db를 초기화하는 아래의 코드는, 이미 DB가 존재할 경우 그 스키마를 삭제하진 않는다. 
```python
# main.py
models.Base.metadata.create_all(engine)
```

## Select Query
```Python
# db 인스턴스로부터 쿼리 
return db.query(DbUser).all()
```